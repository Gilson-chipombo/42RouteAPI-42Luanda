generator client {
  provider = "prisma-client-js"
}

generator jsonSchema {
  provider = "prisma-json-schema-generator"
  output   = "../schemas"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Admins {
  id        Int     @id @default(autoincrement())
  full_name String?
  username  String? @unique
  email     String? @unique
  passwrd   String?
}

model Cadetes {
  id        Int          @id @default(autoincrement())
  full_name String?
  username  String?      @unique
  email     String?      @unique
  city      String?
  distrit   String?
  passwrd   String?
  phone     Int?
  stop_id   Int?
  stop      MiniBusStop? @relation(fields: [stop_id], references: [id])
  messages  Message[]    @relation("CadeteMessages")
}

model Drivers {
  id              Int                 @id @default(autoincrement())
  full_name       String?
  username        String?             @unique
  email           String?             @unique
  passwrd         String?
  photo           String?
  phone           Int?
  coordinates     DriverCoordinates[]
  messages        Message[]           @relation("DriverMessages")

  // Rota atual do motorista
  current_route_id Int?
  current_route    Route? @relation(fields: [current_route_id], references: [id])
}

model MiniBusStop {
  id        Int         @id @default(autoincrement())
  stop_name String?     @unique
  distrit   String?
  latitude  Float?
  longitude Float?
  cadetes   Cadetes[]

  //Relação com rotas (via tabela pivô)
  routes RouteStops[]
}

model Route {
  id         Int          @id @default(autoincrement())
  route_name String
  description String?

  //Liga várias paragens
  stops RouteStops[]

  //Motoristas podem estar temporariamente nesta rota
  drivers Drivers[]
}

model RouteStops {
  id        Int          @id @default(autoincrement())
  route_id  Int
  stop_id   Int

  // Ordem da paragem na rota
  position  Int

  route     Route      @relation(fields: [route_id], references: [id])
  stop      MiniBusStop @relation(fields: [stop_id], references: [id])

  @@unique([route_id, stop_id]) // Evita repetir paragem na mesma rota
}

model Message {
  id        Int     @id @default(autoincrement())
  id_driver Int
  id_cadete Int
  message   String

  cadete    Cadetes @relation("CadeteMessages", fields: [id_cadete], references: [id])
  driver    Drivers @relation("DriverMessages", fields: [id_driver], references: [id])
}

model DriverCoordinates {
  id        Int     @id @default(autoincrement())
  lat       Float
  long      Float
  id_driver Int @unique
  driver    Drivers @relation(fields: [id_driver], references: [id])
}
